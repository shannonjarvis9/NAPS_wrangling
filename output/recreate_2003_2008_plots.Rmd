---
title: "Recreating NAPS PM 2.5 Plots 2003-2008"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("ggplot2")
library("readxl")
library("dplyr")
library("lubridate")
library("janitor")
library("tidyr")
library("rlang")
```



```{r, echo = FALSE, message = FALSE}
source('~/NAPS_project/NAPS_wrangling/R/0-setup_project.R')

# Load the data we already created
# ------------------------------------------------------------------------------
load(paste0(wd$output, "NAPS_fine.rda"))
load(paste0(wd$output, "spec_fieldblanks_2010_format.rda"))

``` 


```{r, echo = FALSE, message = FALSE}
# Get the station metadata
#-------------------------------------------------------------------------------
NAPS_metadata <- read.csv(paste0(wd$data, "edited_StationsNAPS-StationsSNPA.csv")) %>%
  mutate(station = paste0("S", NAPS)) %>%
  clean_names  %>%
  filter(naps %in% c(30113, 40801, 50104, 54401, 60211, 60427, 62601, 90132, 
                     103202, 101004, 100119)) %>%
  mutate(city = c("Halifax", "Canterbury", "Montréal", "Saint-Anicet" , 
                  "Windsor", "Toronto", "Simcoe", "Edmonton", "Burnaby", 
                  "Abbotsford", "Golden")) %>%
  select(-(so2:pah)) 

# set city to factor so they will be displayed in the correct order 
NAPS_metadata$city <- factor(NAPS_metadata$city, levels=rev(c("Halifax", "Canterbury", 
                             "Montréal", "Saint-Anicet" , "Toronto", "Simcoe",
                             "Windsor", "Edmonton", "Golden", "Abbotsford", "Burnaby")))



pm25_bind <- bind_rows(NAPS_fine, .id = "station") %>%
  clean_names()

fb_bind <- bind_rows(lapply(field_blanks, `[[`, 1), .id = "station") %>%
  clean_names()

pm25_fb_bind <- merge(pm25_bind, fb_bind[,c("date", "cart_fb_poc_fb", "oc_r", "station")], 
                      by = c("date", "station"), all.x = TRUE, all.y = TRUE) 

# filter for the relevant sites and relevant years 
spec_R_03_08 <- pm25_fb_bind %>%
  filter( 2003 <= year & year <= 2008) %>%
  filter( station %in% c("S30113", "S40801", "S50104", "S54401", "S60211", 
                         "S60427", "S62601", "S90132", "S103202", "S101004", "S100119")) 

spec_data <- merge(spec_R_03_08, NAPS_metadata, by = "station")
spec_data <- spec_data[,which(unlist(lapply(spec_data, function(x) !all(is.na(x)))))]
# spec_data <- select(spec_data, -contains("flag"))
```



```{r, echo = FALSE, message = FALSE}
# Need to replace all values below the mdl with 1/2*mdl  (section 2.3 in paper)

# Start by subsetting the cols that have a mdl: each col is followed by its mdl
##-----------------------------------------------------------------------------
df <- select(spec_data, contains("edxrf")|contains("ions_ic")|
               contains("metals_icpms")|contains("ammonia_ic")) %>%
  select(-contains("mass"))


#do ocec sperately - some mdl cols are missing, order is not present
df_ocec <- select(spec_data, contains("ocec"))


# Function: mutate_using_mdl
##---------------------------------------------------
## Mutates the col using the mdl column: replaces all 
## col values below the mdl with 1/2*mdl
mutate_using_mdl <- function(df, col, colmdl){
  col <- names(df)[i]
  colmdl <- names(df)[i+1]
  df %>% mutate(!!rlang::ensym(col) := ifelse(!!rlang::ensym(col)  < !!rlang::ensym(colmdl) ,
                                                    0.5*!!rlang::ensym(colmdl), !!rlang::ensym(col) ))
}


# Mutate the columns 
##-----------------------------------------------------------------------------

for(i in seq(1,ncol(df),2)){
  df <- mutate_using_mdl(df, i, i+1)
}



mdl_cols <- grep("mdl", names(df_ocec))
corresp_cols <- substr(names(df_ocec)[mdl_cols],1,nchar(names(df_ocec)[mdl_cols])-4)

for(i in seq_along(corresp_cols)){
  idx <- which(names(df_ocec) %in% corresp_cols[i])
  if(!is_empty(idx)){
    df_ocec <- mutate_using_mdl(df_ocec, idx, mdl_cols[i])
  }
}

# Replace the mutated cols in the data frame
##-----------------------------------------------------------------------------
spec_data[,which(names(spec_data) %in% names(df))] <- df
spec_data[,which(names(spec_data) %in% names(df_ocec))] <- df_ocec
```

# Table 2: Number of samples by site
There are differences in the number of observations for all cities. 
```{r, echo = FALSE, message = FALSE}
#------------------------------------------------------------------------------
#------------------------------------------------------------------------------
# Table 2: Approx num obsv as number of spec obsv - numbers are diff 
#------------------------------------------------------------------------------
#------------------------------------------------------------------------------
library("knitr")
# Lets get count of spec mass obsv by stations 
tbl <- spec_data %>%
  select("city","station", "date")%>%
  group_by(city, station) %>%
  dplyr::summarise(`number of samples` = n())

vals_from_paper <- data.frame(station = c("S30113", "S40801", "S50104", "S54401", 
                                          "S60211", "S60427", "S62601", "S90132", 
                                          "S103202", "S101004", "S100119"),
                         n_paper = c(177, 346, 554, 664, 267, 565, 311, 333, 251, 
                                    537, 695))

tbl_op <- merge(vals_from_paper, tbl, by = "station")
tbl_op$diff <- tbl_op$`number of samples` - tbl_op$n_paper

kable(tbl_op[,c(1,3,4,2,5)])
```

# Figure 2: Total $PM_{2.5}$ mass by site 
There are differences from the boxplot in the paper - several
outliers are missing (Burnaby, Edmonton) 
```{r, echo = FALSE, message = FALSE, warning = FALSE, fig.height = 3.5}
#------------------------------------------------------------------------------
#------------------------------------------------------------------------------
# Figure 2 
#------------------------------------------------------------------------------
#------------------------------------------------------------------------------
fig2 <- spec_data %>%
  select(city, speciation_mass_ug_m3) %>%
  mutate(min = quantile(speciation_mass_ug_m3, 0.02, na.rm = TRUE),
        max = quantile(speciation_mass_ug_m3, 0.98, na.rm = TRUE))

ggplot(data = fig2, mapping = aes(x = city, y = speciation_mass_ug_m3, ymin = min,
       ymax = max)) + 
  geom_boxplot() +
  ylim(0, 80) + 
  labs(y =   expression(PM[2.5] ~ Mass ~ (mu ~ g/m^3)), x = " ")  + 
  scale_x_discrete(labels = function(labels) {
    fixedLabels <- c()
    for (l in 1:length(labels)) {
      fixedLabels[l] <- paste0(ifelse(l %% 2 == 0, '', '\n'), labels[l])
    }
    return(fixedLabels)
  })

#outliers for burnaby & edmonton missing 
```

# Figure 3: Monthly mean $PM_{2.5}$ mass by site 
Trends are similar, 90% CI differs from the paper.

```{r, echo = FALSE, message = FALSE}

#------------------------------------------------------------------------------
#------------------------------------------------------------------------------
# Figure 3 
#------------------------------------------------------------------------------
#------------------------------------------------------------------------------

monthly_station <- spec_data %>%
  mutate(month_text = month(date, label = TRUE, abbr = TRUE)) %>%
  dplyr::select("city", "speciation_mass_ug_m3", "month", "month_text")%>%
  group_by(city, month, month_text) %>%
  dplyr::summarise(mean = mean(speciation_mass_ug_m3, na.rm = TRUE), 
                   n = n(),
                   sd = sd(speciation_mass_ug_m3, na.rm = TRUE)) %>%
  mutate(CI = qt(0.95, df = n-1)*(sd/sqrt(n)))



ggplot(
  data = monthly_station,
  mapping = aes(
    x = month_text,
    y = mean,
    group = 1,
    ymin = mean - CI,
    ymax = mean + CI
  )
) +
  geom_point() +
  geom_line() +
  geom_errorbar() +
  facet_wrap( ~ city, nrow = 3) +
  ylim(0, 35) +
  labs(y =   expression(paste(
    "Total Mass From Spectation Sampler (", mu, "g/", m ^ 3, ")"
  )), x = "Month")  +
  scale_x_discrete(labels = c("J", "F", "M", "A", "M", "J", "J", "A", "S", "O", "N", "D"))
```

\newpage 

# Figure 4: Mean organic carbon (OC) by site 

```{r, echo = FALSE, message = FALSE}
#------------------------------------------------------------------------------
#------------------------------------------------------------------------------
# Figure 4
#------------------------------------------------------------------------------
#------------------------------------------------------------------------------
oc_station <- spec_data %>%
  mutate(mean_oc_cart_a = ocec_cart_a_oc_r) %>%
  mutate(mean_oc_cart_b = ocec_cart_b_oc_r) %>%
  mutate(passiveTravel_fieldBlank = cart_fb_poc_fb + oc_r) %>% #oc_r + ocec_cart_b_poc_r) %>%
  dplyr::select("city",
                "mean_oc_cart_a",
                "mean_oc_cart_b",
                "passiveTravel_fieldBlank") %>%
  group_by(city) %>%
  dplyr::summarise_if(is.numeric, mean, na.rm = TRUE)  %>%
  pivot_longer(!city, names_to = "type", values_to = "val")

ggplot(oc_station, mapping = aes(x = city, y = val, fill = type)) +
  geom_bar(stat = "identity", position = position_dodge()) +
   scale_fill_discrete(labels = c(
    "Mean OC (QA)",
    "Mean OC Active Blank (QB)",
    "Passive Travel and Field Blank"
   )) +
  scale_y_continuous(limits = c(0, 8), breaks = 0:8) +
  theme(legend.position = c(0.75, 0.825),
        legend.title = element_blank()) +
  labs(y =   expression(Total ~ OC ~ Concentration ~ (mu ~ g / m ^ 3)), x = "")  +
  scale_x_discrete(
    labels = function(labels) {
      fixedLabels <- c()
      for (l in 1:length(labels)) {
        fixedLabels[l] <- paste0(ifelse(l %% 2 == 0, '', '\n'), labels[l])
      }
      return(fixedLabels)
    }
  )


```




```{r, echo = FALSE, message = FALSE}
# Order in the paper changed 
spec_data$city <- factor(spec_data$city, levels=rev(c("Halifax", "Canterbury", 
                              "Saint-Anicet", "Montréal", "Toronto", "Simcoe",
                             "Windsor", "Edmonton", "Golden", "Abbotsford", "Burnaby")))
#------------------------------------------------------------------------------
#------------------------------------------------------------------------------
# Table 4: Compound composition 
#------------------------------------------------------------------------------
#------------------------------------------------------------------------------

# now lets get the columns needed from spec data 
comp_station <- spec_data %>%
  select('city','date', 'month', ions_ic_media_t_nitrate, ions_ic_media_t_sulphate, ions_ic_media_t_ammonium,
         ocec_cart_b_oc_b, ions_ic_media_t_potassium, edxrf_silicon_si, edxrf_calcium_ca, edxrf_iron_fe,  
         edxrf_titanium_ti, edxrf_potassium_k, ocec_cart_a_ec_a, ions_ic_media_t_sodium, ions_ic_media_t_chloride, 
         ammonia_ic_cart_c_ammonia, speciation_mass_ug_m3)

# Ammonium Nitrate (NH4NO3) = [ANO3] = 1.29[NO3 ] # should be teflon filter 
      # Hence, Teflon nitrate was used for mass reconstruction
      # and the Nylon nitrate was neglected for mass reconstruction
      # purposes.
comp_station$ANO3_dat <- 1.29*(comp_station$ions_ic_media_t_nitrate)

# Ammonium sulphates = [ASO4] = [SO4] + [NH4] - 0.29[NO3]
comp_station$ASO4_dat <- comp_station$ions_ic_media_t_sulphate +  
                         comp_station$ions_ic_media_t_ammonium - 
                         0.29*(comp_station$ions_ic_media_t_nitrate)


# Elemental carbon = [EC] 
comp_station$EC_dat <- comp_station$ocec_cart_a_ec_a

# Crustal matter = [SOIL] = 3.48[Si] + 1.63[Ca] + 2.42[Fe] + 1.41[K] + 1.94[Ti]
comp_station$SOIL_dat = 3.48*comp_station$edxrf_silicon_si + 1.63*comp_station$edxrf_calcium_ca + 
                   1.63*comp_station$edxrf_iron_fe + 1.41*comp_station$edxrf_potassium_k +
                   1.94*comp_station$edxrf_titanium_ti


# Sodium chloride = [NaCl] = [Na] + [Cl]
comp_station$NaCl_dat <- comp_station$ions_ic_media_t_sodium + comp_station$ions_ic_media_t_chloride

#Particle-bound water = [PBW] = 0.32 ([SO4] + [NH4 ])
comp_station$PBW_dat <- 0.32*(comp_station$ions_ic_media_t_sulphate + comp_station$ions_ic_media_t_ammonium)


# comp_station$OM_dat <- comp_station$pm2_5 - (comp_station$ANO3_dat + comp_station$ASO4_dat +
#                                            comp_station$EC_dat + comp_station$SOIL_dat + #comp_station$TEO + 
#                                            comp_station$NaCl_dat +
#                                            comp_station$PBW_dat)

# Organic Matter = [OM] = k[OC] 

# Need to add season to comp_station for the OM correction factor 
om_correction_factor <- read_excel(paste0(wd$header, "om_correction_factor.xlsx"))%>% 
  clean_names()
comp_station$season <- ifelse(comp_station$month %in% c(3,4,5), 'spring',
                       ifelse(comp_station$month %in% c(6,7,8), 'summer',
                       ifelse(comp_station$month %in% c(9,10,11), 'fall', 
                       ifelse(comp_station$month %in% c(12,1,2), 'winter', NA))))

comp_station <- merge(comp_station, om_correction_factor[,c("season", "city","correction_factor")],
                      by = c("season", "city"))

comp_station$OM_dat <-comp_station$ocec_cart_b_oc_b*(comp_station$correction_factor)                         
```

\newpage

# Figure 5: Reconstructed $PM_{2.5}$ mass by major component and site  
Large differences from the paper - PBW, ASO4, OM

```{r, echo = FALSE, message = FALSE, fig.height = 4}
#------------------------------------------------------------------------------
#------------------------------------------------------------------------------
# Fig 5: Reconstructed PM 2.5 for Apr-Sept & Oct-March
#------------------------------------------------------------------------------
#------------------------------------------------------------------------------
par(mfrow = c(2, 2)) 

comp_station_april_sept <- comp_station %>%
  filter(4 <= month & month <= 9) %>% 
  dplyr::select("city", "NaCl_dat", "SOIL_dat", "EC_dat", "OM_dat", "ANO3_dat", "ASO4_dat", "PBW_dat")%>%
  group_by(city) %>%
  dplyr::summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  dplyr::rename(NaCl = NaCl_dat, "SOIL" = "SOIL_dat", "EC" = "EC_dat", "OM" = "OM_dat", 
                "ANO3" = "ANO3_dat", "ASO4" = "ASO4_dat","PBW" = "PBW_dat" ) %>%
  pivot_longer(!city, names_to = "type", values_to = "val") 


comp_station_oct_mar <- comp_station %>%
  filter(month <= 3 | month >= 10) %>% 
  dplyr::select("city", "NaCl_dat", "SOIL_dat", "EC_dat", "OM_dat", "ANO3_dat", "ASO4_dat", "PBW_dat")%>%
  group_by(city) %>%
  dplyr::summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  dplyr::rename(NaCl = NaCl_dat, "SOIL" = "SOIL_dat", "EC" = "EC_dat", "OM" = "OM_dat", 
                "ANO3" = "ANO3_dat", "ASO4" = "ASO4_dat","PBW" = "PBW_dat" ) %>%
  pivot_longer(!city, names_to = "type", values_to = "val")



ggplot(comp_station_april_sept, mapping = aes(x = city, y = val, 
        fill = factor(type, levels = c("NaCl", "SOIL", "EC", "OM", "ANO3", "ASO4", "PBW")))) + 
  geom_bar(stat="identity", position=position_stack()) + 
  scale_y_continuous(limits = c(0, 20), breaks = seq(0,20,2)) + 
  theme(legend.position = c(0.95, 0.8), legend.title = element_blank()) + 
  labs(y =   expression(paste(PM[2.5], " Mass (",mu, "g/",m^3,")")), x = "",
       title = "April to September (2003-2008)") +
  scale_x_discrete(labels = function(labels) {
    fixedLabels <- c()
    for (l in 1:length(labels)) {
      fixedLabels[l] <- paste0(ifelse(l %% 2 == 0, '', '\n'), labels[l])
    }
    return(fixedLabels)
  })



ggplot(comp_station_oct_mar, mapping = aes(x = city, y = val, 
        fill = factor(type, levels = c("NaCl", "SOIL", "EC", "OM", "ANO3", "ASO4", "PBW")))) + 
  geom_bar(stat="identity", position=position_stack()) + 
  scale_y_continuous(limits = c(0, 20), breaks = seq(0,20,2)) + 
  theme(legend.position =  c(0.95, 0.8), legend.title = element_blank()) + 
  labs(y =   expression(paste(PM[2.5], " Mass (",mu, "g/",m^3,")")), x = "",
       title = "October to March (2003-2008)")  + 
  scale_x_discrete(labels = function(labels) {
    fixedLabels <- c()
    for (l in 1:length(labels)) {
      fixedLabels[l] <- paste0(ifelse(l %% 2 == 0, '', '\n'), labels[l])
    }
    return(fixedLabels)
  })

```

\newpage 

# Figure 6: Reconstructed $PM_{2.5}$ mass by 10 highest mass days and site  
Large differences from the paper - PBW, ASO4, OM


```{r, echo = FALSE, message = FALSE, fig.height = 4}

# Paper stated that "Mean total mass concentration exceeded 30 mg m3 for the 10 
# highest days at the Ontario and Quebec urban sites in both summer and winter". 
# Statement is inconsistent with my findings, mean total mass for those sites
# were (27, 39) for summer and (24, 50) in winter. 

#------------------------------------------------------------------------------
#------------------------------------------------------------------------------
# Fig 6: Reconstructed PM 2.5 for 10 highest days Apr-Sept & Oct-March
#------------------------------------------------------------------------------
#------------------------------------------------------------------------------

comp_station_renamed <- comp_station %>%
  dplyr::select("city","month", "NaCl_dat", "SOIL_dat", "EC_dat", "OM_dat", "ANO3_dat", 
                "ASO4_dat", "PBW_dat", speciation_mass_ug_m3) %>%
  dplyr::rename(NaCl = NaCl_dat, "SOIL" = "SOIL_dat", "EC" = "EC_dat", "OM" = "OM_dat", 
                "ANO3" = "ANO3_dat", "ASO4" = "ASO4_dat","PBW" = "PBW_dat" ) 

highest_10_april_sept <-  comp_station_renamed %>%
  filter(4 <= month & month <= 9) %>%
  group_by(city) %>%
  arrange(desc(speciation_mass_ug_m3)) %>%
  slice(1:10) %>%
  select(-c(speciation_mass_ug_m3, month)) %>%
  dplyr::summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  pivot_longer(!city, names_to = "type", values_to = "val")


highest_10_oct_mar <- comp_station_renamed %>% 
  filter(month <= 3 | month >= 10) %>% 
  group_by(city) %>% 
  arrange(desc(speciation_mass_ug_m3)) %>%
  slice(1:10) %>% 
  select(-c(speciation_mass_ug_m3, month)) %>% 
  dplyr::summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  pivot_longer(!city, names_to = "type", values_to = "val")




ggplot(highest_10_april_sept, 
       mapping = aes(x = city, y = val, fill = factor(type, levels = 
                     c("NaCl", "SOIL", "EC", "OM", "ANO3", "ASO4", "PBW")))) + 
  geom_bar(stat="identity", position=position_stack()) + 
  scale_y_continuous(limits = c(0, 60), breaks = seq(0,60,10)) + 
  theme(legend.position =  c(0.95, 0.775), legend.title = element_blank()) + 
  labs(y =   expression(paste(PM[2.5], " Mass (",mu, "g/",m^3,")")), x = "",
       title = "April to September (2003-2008)") + 
  scale_x_discrete(labels = function(labels) {
    fixedLabels <- c()
    for (l in 1:length(labels)) {
      fixedLabels[l] <- paste0(ifelse(l %% 2 == 0, '', '\n'), labels[l])
    }
    return(fixedLabels)
  })



ggplot(highest_10_oct_mar, 
       mapping = aes(x = city, y = val,fill = factor(type, levels =
                     c("NaCl", "SOIL", "EC", "OM", "ANO3", "ASO4", "PBW")))) + 
  geom_bar(stat="identity", position=position_stack()) + 
  scale_y_continuous(limits = c(0, 60), breaks = seq(0,60,10)) +  
  theme(legend.position =  c(0.95, 0.775), legend.title = element_blank()) + 
  labs(y =   expression(paste(PM[2.5], " Mass (",mu, "g/",m^3,")")), x = "",
       title = "October to March (2003-2008)") +
  scale_x_discrete(labels = function(labels) {
    fixedLabels <- c()
    for (l in 1:length(labels)) {
      fixedLabels[l] <- paste0(ifelse(l %% 2 == 0, '', '\n'), labels[l])
    }
    return(fixedLabels)
  })

```


# Figure 7: Median ammonium sulphate and ammonium nitrate concentrations by site and month 

```{r, echo = FALSE, message = FALSE}
# Order in the paper changed back
spec_data$city <- factor(spec_data$city, levels=rev(c("Halifax", "Canterbury", 
                              "Montréal", "Saint-Anicet", "Toronto", "Simcoe",
                             "Windsor", "Edmonton", "Golden", "Abbotsford", "Burnaby")))
#------------------------------------------------------------------------------
#------------------------------------------------------------------------------
# Figure 7: Ammonia Sulphate and Nitrate 
#------------------------------------------------------------------------------
#------------------------------------------------------------------------------

# calculate our summary statisitcs 
ammon_compnd <- comp_station %>%
  mutate(month_text = month(date, label = TRUE, abbr = TRUE)) %>%
  select(city, ASO4_dat, ANO3_dat, month_text) %>%
  group_by(city, month_text) %>%
  dplyr::summarise(ASO4 = median(ASO4_dat, na.rm = TRUE),  
                   ANO3 = median(ANO3_dat, na.rm = TRUE),
                   lwr_quantile_aso4 = quantile(ASO4_dat, na.rm = TRUE, probs = 0.25),
                   upr_quantile_aso4 = quantile(ASO4_dat, na.rm = TRUE, probs = 0.75),
                   lwr_quantile_ano3 = quantile(ANO3_dat, na.rm = TRUE, probs = 0.25),
                   upr_quantile_ano3 = quantile(ANO3_dat, na.rm = TRUE, probs = 0.75)) 


# need to structure the df (city, month, compound, value, lower IQR, upper IQR) 
# for easy plotting - there is probably a much easier way to do this! 
#------------------------------------------------------------------------------
# start by putting the IQR in the correct format 
ano3_IQR <- ammon_compnd %>%
  select(c(city, month_text, lwr_quantile_ano3, upr_quantile_ano3)) %>%
  mutate(compound = "ANO3") %>%
  dplyr::rename(lower_iqr = lwr_quantile_ano3,  upper_iqr = upr_quantile_ano3)

aso4_IQR <- ammon_compnd %>%
  select(c(city, month_text, lwr_quantile_aso4, upr_quantile_aso4)) %>%
  mutate(compound = "ASO4") %>%
  dplyr::rename(lower_iqr = lwr_quantile_aso4,  upper_iqr = upr_quantile_aso4)

ammon_iqr <- bind_rows(ano3_IQR, aso4_IQR)

# Then merge the IQR back with the original df 
ammon_compnd_median <- ammon_compnd %>%
  select(c(city, month_text, ASO4, ANO3)) %>%
  pivot_longer(!c(city, month_text), names_to = "compound", values_to = "median") 

ammonia_data <- merge(ammon_compnd_median, ammon_iqr, by = c("city", "month_text", "compound"))



# lets plot! 
ggplot(data = ammonia_data, mapping = aes(x = month_text, y = median, colour = compound, linetype = compound,
                                          group = compound, ymin = lower_iqr, ymax = upper_iqr)) + 
  geom_point() + 
  geom_line() +
  geom_errorbar() +
  facet_wrap(~ city, nrow = 3) + 
  scale_y_continuous(limits = c(0, 12), breaks = seq(0,12,2)) + 
  scale_linetype_manual(values = c("ANO3" = "dashed", "ASO4" = "solid")) + 
  labs(y =   expression(paste("Ammonium Sulphate/Ammonium Nitrate (",mu ,"g/",m^3,")")), x = "Month")  + 
  scale_x_discrete(labels= c("J", "F", "M", "A", "M", "J", "J", "A", "S", "O", "N", "D"))
```


# Figure 8: Median elemental carbomn (EC) and organic matter (OM) concentrations by site and month 


```{r, echo = FALSE, message = FALSE}
#------------------------------------------------------------------------------
#------------------------------------------------------------------------------
# Figure 8: EC and OC
#------------------------------------------------------------------------------
#------------------------------------------------------------------------------

# calculate our summary statisitcs 
carb_compnd <- comp_station %>%
  mutate(month_text = month(date, label = TRUE, abbr = TRUE)) %>%
  select(city, EC_dat, OM_dat, month_text) %>%
  group_by(city, month_text) %>%
  dplyr::summarise(EC = median(EC_dat, na.rm = TRUE)*3,  
                   OM = median(OM_dat, na.rm = TRUE),
                   lwr_quantile_EC = quantile(EC_dat, na.rm = TRUE, probs = 0.25)*3,
                   upr_quantile_EC = quantile(EC_dat, na.rm = TRUE, probs = 0.75)*3,
                   lwr_quantile_OM = quantile(OM_dat, na.rm = TRUE, probs = 0.25),
                   upr_quantile_OM = quantile(OM_dat, na.rm = TRUE, probs = 0.75)) 


# need to structure the df (city, month, compound, value, lower IQR, upper IQR) 
# for easy plotting - there is probably a much easier way to do this! 
#------------------------------------------------------------------------------
# start by putting the IQR in the correct format 
om_IQR <- carb_compnd %>%
  select(c(city, month_text, lwr_quantile_OM, upr_quantile_OM)) %>%
  mutate(compound = "OM") %>%
  dplyr::rename(lower_iqr = lwr_quantile_OM,  upper_iqr = upr_quantile_OM)

ec_IQR <- carb_compnd %>%
  select(c(city, month_text, lwr_quantile_EC, upr_quantile_EC)) %>%
  mutate(compound = "EC") %>%
  dplyr::rename(lower_iqr = lwr_quantile_EC,  upper_iqr = upr_quantile_EC)

carb_iqr <- bind_rows(om_IQR, ec_IQR)

# Then merge the IQR back with the original df 
carb_compnd_median <- carb_compnd %>%
  select(c(city, month_text, OM, EC)) %>%
  mutate(EC = EC) %>%
  pivot_longer(!c(city, month_text), names_to = "compound", values_to = "median") 

carb_data <- merge(carb_compnd_median, carb_iqr, by = c("city", "month_text", "compound"))



# lets plot! 
ggplot(data = carb_data, mapping = aes(x = month_text, y = median, colour = compound, linetype = compound,
                                          group = compound, ymin = lower_iqr, ymax = upper_iqr)) + 
  geom_point() + 
  geom_line() +
  geom_errorbar() +
  facet_wrap(~ city, nrow = 3) + 
  scale_y_continuous(limits = c(0, 18), breaks = seq(0,18,3),
                     expression(paste("OM (",mu ,"g/",m^3,")")), 
                     sec.axis = sec_axis(~ . / 3, name = expression(paste("EC (",mu ,"g/",m^3,")")),
                                         breaks = seq(0,6,1))) +
  scale_linetype_manual(values = c("EC" = "dashed", "OM" = "solid")) + 
  labs(x = "Month")  + 
  scale_x_discrete(labels= c("J", "F", "M", "A", "M", "J", "J", "A", "S", "O", "N", "D")) + 
    theme(axis.line.y.right = element_line(color = "#F8766D"),
          axis.text.y.right = element_text(color = "#F8766D"),
          axis.line.y.left = element_line(color = "#00BFC4"),
          axis.text.y.left = element_text(color = "#00BFC4"))
```

\newpage 

# Figure 9: Median soil and sodium chloride concentrations by site and month 
```{r, echo = FALSE, message = FALSE, warning = FALSE}
#------------------------------------------------------------------------------
#------------------------------------------------------------------------------
# Figure 9: SOIL and NaCl
#------------------------------------------------------------------------------
#------------------------------------------------------------------------------

# see if there is an observation of SOIL thats weird 
highest_10_april_sept <-  comp_station %>%
  filter(city == "Simcoe") %>%
  filter(month == 5) %>%
  arrange(desc(SOIL_dat))  %>%
  select(city, SOIL_dat, NaCl_dat, month, date)

# calculate our summary statisitcs 
fig9_compnd <- comp_station %>%
  mutate(month_text = month(date, label = TRUE, abbr = TRUE)) %>%
  select(city, SOIL_dat, NaCl_dat, month_text) %>%
  group_by(city, month_text) %>%
  dplyr::summarise(SOIL = median(SOIL_dat, na.rm = TRUE),  
                   NaCl = median(NaCl_dat, na.rm = TRUE),
                   lwr_quantile_SOIL = quantile(SOIL_dat, na.rm = TRUE, probs = 0.25),
                   upr_quantile_SOIL = quantile(SOIL_dat, na.rm = TRUE, probs = 0.75),
                   lwr_quantile_NaCl = quantile(NaCl_dat, na.rm = TRUE, probs = 0.25),
                   upr_quantile_NaCl = quantile(NaCl_dat, na.rm = TRUE, probs = 0.75)) 



soil_IQR <- fig9_compnd %>%
  select(c(city, month_text, lwr_quantile_SOIL, upr_quantile_SOIL)) %>%
  mutate(compound = "SOIL") %>%
  dplyr::rename(lower_iqr = lwr_quantile_SOIL,  upper_iqr = upr_quantile_SOIL)

nacl_IQR <- fig9_compnd %>%
  select(c(city, month_text, lwr_quantile_NaCl, upr_quantile_NaCl)) %>%
  mutate(compound = "NaCl") %>%
  dplyr::rename(lower_iqr = lwr_quantile_NaCl,  upper_iqr = upr_quantile_NaCl)

fig9_iqr <- bind_rows(soil_IQR, nacl_IQR)

# Then merge the IQR back with the original df 
fig9_compnd_median <- fig9_compnd %>%
  select(c(city, month_text, SOIL, NaCl)) %>%
  pivot_longer(!c(city, month_text), names_to = "compound", values_to = "median") 

fig9_data <- merge(fig9_compnd_median, fig9_iqr, by = c("city", "month_text", "compound"))



# lets plot! 
ggplot(data = fig9_data, mapping = aes(x = month_text, y = median, colour = compound, linetype = compound,
                                       group = compound, ymin = lower_iqr, ymax = upper_iqr)) + 
  geom_point() + 
  geom_line() +
  geom_errorbar() +
  facet_wrap(~ city, nrow = 3) + 
  scale_y_continuous(limits = c(0, 3), breaks = seq(0,3,0.5)) + 
  scale_linetype_manual(values = c("NaCl" = "dashed", "SOIL" = "solid")) + 
  labs(y = expression(paste("Ammonium Sulphate/Ammonium Nitrate (",mu ,"g/",m^3,")")), x = "Month")  + 
  scale_x_discrete(labels= c("J", "F", "M", "A", "M", "J", "J", "A", "S", "O", "N", "D"))
```

# Figure 10: Ammonia mixing ratio by site and month 


```{r, echo = FALSE, message = FALSE}

#------------------------------------------------------------------------------
#------------------------------------------------------------------------------
# Figure 10: Ammonia - cart c
#------------------------------------------------------------------------------
#------------------------------------------------------------------------------

# calculate our summary statisitcs 
ammonia_compnd <- comp_station %>%
  mutate(month_text = month(date, label = TRUE, abbr = TRUE)) %>%
  select(city, ammonia_ic_cart_c_ammonia, month_text) %>%
  group_by(city, month_text) %>%
  dplyr::summarise(Ammonia = median(ammonia_ic_cart_c_ammonia, na.rm = TRUE),  
                   lwr_quantile = quantile(ammonia_ic_cart_c_ammonia, na.rm = TRUE, probs = 0.25),
                   upr_quantile = quantile(ammonia_ic_cart_c_ammonia, na.rm = TRUE, probs = 0.75)) 


# lets plot! 
ggplot(data = ammonia_compnd %>% filter(city != "Abbotsford"),
       mapping = aes(x = month_text, y = Ammonia,group = 1, ymin = lwr_quantile, ymax = upr_quantile)) + 
  geom_point() + 
  geom_line() +
  geom_errorbar() +
  facet_wrap(~ city, nrow = 3) + 
  scale_y_continuous(limits = c(0, 5), breaks = 0:5) + 
  labs(y = "Ammonia (ppb)", x = "Month")  + 
  scale_x_discrete(labels= c("J", "F", "M", "A", "M", "J", "J", "A", "S", "O", "N", "D"))
```

```{r, echo = FALSE, message = FALSE, fig.height = 2, fig.width= 2}

ggplot(data = ammonia_compnd %>% filter(city == "Abbotsford"), 
       mapping = aes(x = month_text, y = Ammonia,group = 1, ymin = lwr_quantile, ymax = upr_quantile)) + 
  geom_point() + 
  geom_line() +
  geom_errorbar() +
  scale_y_continuous(limits = c(0, 50), breaks = seq(0,50,10)) + 
  labs(y = "Ammonia (ppb)", x = "Month", title = "Abbotsford")  + 
  scale_x_discrete(labels= c("J", "F", "M", "A", "M", "J", "J", "A", "S", "O", "N", "D"))
```

# Figure 11: Median sulphr dioxide mixing ratio and nitric acid concentrations by site and month 


```{r, echo = FALSE, message = FALSE}

#------------------------------------------------------------------------------
#------------------------------------------------------------------------------
# Figure 11: Sulphr dioxide, nitric acid 
#------------------------------------------------------------------------------
#------------------------------------------------------------------------------

sulphr_compnd <- spec_data %>%
  mutate(month_text = month(date, label = TRUE, abbr = TRUE)) %>%
  select(city, so2, month_text) %>%
  group_by(city, month_text) %>%
  dplyr::summarise(median = median(so2, na.rm = TRUE),  
                   lwr_quantile = quantile(so2, na.rm = TRUE, probs = 0.25),
                   upr_quantile = quantile(so2, na.rm = TRUE, probs = 0.75)) %>%
  mutate(compound = "SO2") 
  
nitricacid_compnd <- spec_data %>%
  mutate(month_text = month(date, label = TRUE, abbr = TRUE)) %>%
  select(city, nitric_acid, month_text) %>%
  group_by(city, month_text) %>%
  dplyr::summarise(median = median(nitric_acid, na.rm = TRUE)*10,  #multiply by 10 b.c. diff axis
                   lwr_quantile = quantile(nitric_acid, na.rm = TRUE, probs = 0.25)*10,
                   upr_quantile = quantile(nitric_acid, na.rm = TRUE, probs = 0.75)*10) %>%
  mutate(compound = "Nitric Acid") 

fig11_dat <- bind_rows(sulphr_compnd, nitricacid_compnd)

# lets plot! 
ggplot(data = fig11_dat,
       mapping = aes(x = month_text, y = median, group = compound, linetype = compound, 
                     colour = compound, ymin = lwr_quantile, ymax = upr_quantile)) + 
  geom_point() + 
  geom_line() +
  geom_errorbar() +
  facet_wrap(~ city, nrow = 3) + 
  #scale_linetype_manual(values = c("SO2" = "dashed", "Nirtic Acid" = "solid")) +
  scale_y_continuous(limits = c(0, 12), breaks = seq(0,12,2),
                     expression(paste("Sulphr Dioxide (",mu ,"g/",m^3,")")), 
    sec.axis = sec_axis(~ . / 10, name = expression(paste("Nitric Acid (",mu ,"g/",m^3,")")),
                        breaks = seq(0,1.2,0.2))) +
  labs(x = "Month")  + 
  scale_x_discrete(labels= c("J", "F", "M", "A", "M", "J", "J", "A", "S", "O", "N", "D")) + 
  theme(axis.line.y.right = element_line(color = "#F8766D"),
        axis.text.y.right = element_text(color = "#F8766D"),
        axis.line.y.left = element_line(color = "#00BFC4"),
        axis.text.y.left = element_text(color = "#00BFC4"))

```